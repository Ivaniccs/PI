{% extends 'base.html' %}
{% block content %}
<div class="carrinho-container">
    <h2 style="text-align: center";>Seu Carrinho</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if not carrinho_itens %}
        <p style="text-align: center";>Seu carrinho está vazio</p>
    {% else %}
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in carrinho_itens %}
                <tr>
                    <td>
                        <img src="{{ url_for('static', filename=item.imagem.replace('static/', '')) }}" width="50" height="40">
                        {{ item.nome }}
                    </td>
                    <td>R$ {{ "%.2f"|format(item.preco) }}</td>
                    <td>
                        <form action="{{ url_for('atualizar_carrinho') }}" method="post">
                            <input type="hidden" name="produto_id" value="{{ item.id }}">
                            <input type="number" name="quantidade" value="{{ item.quantidade }}" min="1" max="{{ item.estoque_disponivel }}">
                            <button type="submit">Atualizar</button>
                        </form>
                    </td>
                    <td>R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</td>
                    <td>
                        <a href="{{ url_for('remover_do_carrinho', produto_id=item.id) }}" class="btn btn-danger">Remover</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="total">
            <h4 style="text-align: center">Total: R$ {{ "%.2f"|format(total) }}</h4>
        </div>
        
        <!-- Botão Finalizar Compra -->
        <button style="display: block; margin: 30px auto; padding: 10px 30px; font-size: 1.1em; max-width: 100%;" 
                        id="finalizarCompra" class="btn btn-success">Finalizar Compra</button>

        <!-- Modal/Popup (no final do body) -->
        <div id="modalFinalizar" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>Informações Adicionais</h3>
                <form id="formFinalizar">
                    <div class="input_modal">
                        <label for="nome" class="form-label">Nome</label>
                        <input type="text" id="nomeCliente" placeholder="Seu Nome" required>
                    </div>
                    <div class="input_modal">
                        <label for="aluno" class="form-label">Aluno</label>
                        <input type="text" id="nomeAluno" placeholder="Nome do Aluno" required>
                    </div>
                    <div class="input_modal">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea rows="3" id="observacoes" placeholder="Observações"></textarea>
                    </div> 
                    
                    <div id="qrcode-container" style="display: none;">
                        <h2>QR Code para Pagamento</h2>
                        <img id="qrcode-img" src="" alt="QR Code">
                        <p>Escaneie este QR Code com o app do Mercado Pago para realizar o pagamento de R$ {{ "%.2f"|format(total) }}.</p>
                    </div>
                    <button style="display: block; margin: 30px auto; padding: 10px 30px; font-size: 1.1em; max-width: 100%;" 
                            id="gerar-qrcode" class="btn btn-success">Pagamento</button>
                    <!-- <button type="submit" class="btn btn-primary">Enviar Pedido</button> -->
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('modalFinalizar');
                const btnFinalizar = document.getElementById('finalizarCompra');
                const btnClose = document.querySelector('.close');
                const btnGerarQRCode = document.getElementById('gerar-qrcode');
                const formFinalizar = document.getElementById('formFinalizar');
                const qrContainer = document.getElementById('qrcode-container');
                const qrImg = document.getElementById('qrcode-img');
                const total = {{ total|tojson }};

                // Abre o modal
                btnFinalizar.addEventListener('click', function() {
                    modal.style.display = 'block';
                });

                // Fecha o modal
                btnClose.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
                /*
                window.addEventListener('click', function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                });
                */

                // Lógica principal ao clicar em "Gerar QR Code"
                btnGerarQRCode.addEventListener('click', async function() {
                    const nomeCliente = document.getElementById('nomeCliente').value;
                    if (!nomeCliente) {
                        alert('Por favor, preencha seu nome para continuar.');
                        return;
                    }

                    btnGerarQRCode.textContent = 'Gerando...';
                    btnGerarQRCode.disabled = true;

                    try {
                        const response = await fetch("{{ url_for('gerar_qrcode_pix') }}", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                nome: nomeCliente,
                                // O total é calculado no backend
                            })
                        });

                        const data = await response.json();

                        if (!data.success) {
                            //alert('Erro: ' + data.error);
                            alert('Falha ao gerar QR Code automático. \nEscaneie o QR Code e informe o valor total de R$ ' + total.toFixed(2) + '.');
                            qrImg.src = 'static/fotos/QR_CODE_TESTE.png';
                            qrContainer.style.display = 'block';
                        }
                        else
                        {
                            alert('PIX gerado com sucesso! Agora você pode enviar o pedido via WhatsApp.');
                            // Exibe o QR Code
                            qrImg.src = 'data:image/png;base64,' + data.qr_code_base64;
                            qrContainer.style.display = 'block';
                            // Esconde o botão de gerar QR Code e o de Enviar Pedido
                            btnGerarQRCode.style.display = 'none';
                            document.getElementById('formFinalizar').querySelector('button[type="submit"]').style.display = 'none';
                        }                                         

                    } catch (error) {
                        console.error('Erro:', error);
                        alert('Erro ao conectar com o servidor de pagamento.');
                    } finally {
                        btnGerarQRCode.textContent = 'Gerar QR Code';
                        btnGerarQRCode.disabled = false;
                    }
                    criarBotaoWhatsApp();
                });

                function criarBotaoWhatsApp() {
                    const nomeCliente = document.getElementById('nomeCliente').value;
                    const nomeAluno = document.getElementById('nomeAluno').value;
                    const observacoes = document.getElementById('observacoes').value;

                    let itensMsg = '';
                    {% for item in carrinho_itens %}
                        itensMsg += `- {{ item.nome }} ({{ item.quantidade }}x) R$ {{ "%.2f"|format(item.preco * item.quantidade) }}\n`;
                    {% endfor %}

                    const mensagem = `*NOVO PEDIDO *\n\n` +
                                    `*Cliente:* ${nomeCliente}\n` +
                                    `*Aluno:* ${nomeAluno}\n` +
                                    `*Observações:* ${observacoes}\n\n` +
                                    `*Itens:*\n${itensMsg}` +
                                    `\n*Total:* R$ ${total.toFixed(2)}`;

                    const telefone = '5512991493352'; // Sem o '+'
                    const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;

                    const botaoAntigo = document.getElementById('whatsappBtn');
                    if (botaoAntigo) {
                        botaoAntigo.remove(); // Se encontrar, remove o botão antigo
                    }    
                    const whatsappBtn = document.createElement('a');
                    whatsappBtn.id = 'whatsappBtn';
                    whatsappBtn.href = url;
                    whatsappBtn.target = '_blank';
                    whatsappBtn.className = 'btn btn-success'; 
                    whatsappBtn.innerText = 'Enviar Pedido via WhatsApp';
                    whatsappBtn.style.marginTop = '15px';
                    // 2. CENTRALIZAR O BOTÃO
                    whatsappBtn.style.display = 'block';     
                    whatsappBtn.style.width = 'fit-content'; 
                    whatsappBtn.style.margin = '15px auto 0 auto';
                    
                    // Adiciona o botão do WhatsApp ao formulário
                    formFinalizar.appendChild(whatsappBtn);
                }
            });
        </script>
       
    {% endif %}

{% endblock %}