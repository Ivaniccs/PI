{% extends 'base.html' %}
{% block content %}
<div class="carrinho-container">
    <h2 style="text-align: center";>Seu Carrinho</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if not carrinho_itens %}
        <p style="text-align: center";>Seu carrinho está vazio</p>
    {% else %}
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in carrinho_itens %}
                <tr>
                    <td>
                        <img src="{{ item.imagem }}" width="50" height="40">
                        {{ item.nome }}
                    </td>
                    <td>R$ {{ "%.2f"|format(item.preco) }}</td>
                    <td>
                        <form action="{{ url_for('atualizar_carrinho') }}" method="post">
                            <input type="hidden" name="produto_id" value="{{ item.id }}">
                            <input type="number" name="quantidade" value="{{ item.quantidade }}" min="1" max="{{ item.estoque_disponivel }}">
                            <button type="submit">Atualizar</button>
                        </form>
                    </td>
                    <td>R$ {{ "%.2f"|format(item.subtotal) }}</td>
                    <td>
                        <a href="{{ url_for('remover_do_carrinho', produto_id=item.id) }}" class="btn btn-danger">Remover</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="total">
            <h4 style="text-align: center">Total: R$ {{ "%.2f"|format(total) }}</h4>
        </div>

        <!-- Botão Finalizar Compra -->
<button style="display: block; margin: 30px auto; padding: 10px 30px; font-size: 1.1em; max-width: 100%;" 
                id="finalizarCompra" class="btn btn-success">Finalizar Compra</button>

<!-- Modal/Popup (no final do body) -->
<div id="modalFinalizar" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Informações Adicionais</h3>
    <form id="formFinalizar">
        <div class="input_modal">
            <label for="nome" class="form-label">Nome</label><br>
            <input type="text" id="nomeCliente" placeholder="Seu Nome" required>
        </div>
        <div class="input_modal">
            <label for="aluno" class="form-label">Aluno</label><br>
            <input type="text" id="nomeAluno" placeholder="Nome do Aluno" required>
        </div>
        <div class="input_modal">
            <label for="observacoes" class="form-label">Observações</label><br>
            <textarea rows="3" id="observacoes" placeholder="Observações"></textarea>
        </div>
      
     <!-- <div id="qrCodeContainer" style="display:none;">
        <h4>Pagamento via Mercado Pago</h4>
        <img id="qrCodeImg" src="" alt="QR Code">
        <p>Total: R$ <span id="totalQrCode"></span></p>
      </div> -->
      
      <button type="submit" class="btn btn-primary">Enviar Pedido</button>
    </form>
  </div>
</div>

<script>
    document.getElementById('finalizarCompra').addEventListener('click', function() {
        document.getElementById('modalFinalizar').style.display = 'block';
        console.log('blockkk');
      });
      
      document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('modalFinalizar').style.display = 'none';
        console.log('noneee');
      });
      
      document.getElementById('formFinalizar').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Obter dados do formulário
        const nomeCliente = document.getElementById('nomeCliente').value;
        const nomeAluno = document.getElementById('nomeAluno').value;
        const observacoes = document.getElementById('observacoes').value;
        const total = {{ total|tojson }};
        
        // Montar lista de itens
        let itensMsg = '';
        {% for item in carrinho_itens %}
            itensMsg += `- {{ item.nome }} ({{ item.quantidade }}x) R$ {{ "%.2f"|format(item.subtotal) }}\n`;
        {% endfor %}
        
        // Montar mensagem completa
        const mensagem = `*NOVO PEDIDO*\n\n` +
                        `*Cliente:* ${nomeCliente}\n` +
                        `*Aluno:* ${nomeAluno}\n` +
                        `*Observações:* ${observacoes}\n\n` +
                        `*Itens:*\n${itensMsg}` +
                        `\n*Total:* R$ ${total.toFixed(2)}`;
        
        // Enviar para WhatsApp
        const telefone = '+5512982841105'; // Sem o +
        const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
        
        // Fechar o modal
        document.getElementById('modalFinalizar').style.display = 'none';
    });
      
      async function gerarQrCode(total) {
        try {
          const response = await fetch('/gerar-qrcode', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ total: total })
          });
          
          const data = await response.json();
          
          if(data.success) {
            document.getElementById('qrCodeImg').src = `data:image/png;base64,${data.qr_code_base64}`;
            document.getElementById('totalQrCode').textContent = total.toFixed(2);
          } else {
            alert('Erro ao gerar QR Code: ' + data.error);
          }
        } catch (error) {
          alert('Falha na comunicação com o servidor');
          console.error(error);
        }
      }
    </script>
        

    {% endif %}
</div>
{% endblock %}